name: Medusa B2B Deploy

on:
  push:
    branches:
      - main # Убедитесь, что это имя вашей основной ветки (например, master)

# --- Переменные окружения для ВСЕГО JOB-а ---
# Здесь мы определяем все переменные окружения, включая те, что из секретов GitHub.
# Они будут доступны для ВСЕХ ШАГОВ в этом JOB.

jobs:
  deploy:
    runs-on: ubuntu-latest # Вы можете использовать self-hosted runner, если нужно

    steps:
      - name: Checkout code
        # Выгружает код из вашего репозитория
        uses: actions/checkout@v4

      # Пропускаем шаги сборки (например, yarn install, build) на CI runner,
      # поскольку они будут выполнены вручную на сервере в первый раз.

      - name: Copy project files to server
        # Используем action для копирования файлов по SCP
        uses: appleboy/scp-action@v0.1.4 # Проверьте наличие более новой версии, если хотите
        with:
          host: ${{ secrets.SSH_HOST }} # IP-адрес сервера из секретов GitHub
          username: ${{ secrets.SSH_USER }} # Имя пользователя SSH из секретов GitHub
          key: ${{ secrets.SERVER_SSH_KEY }} # Приватный SSH-ключ из секретов GitHub
          port: ${{ secrets.SSH_PORT }} # Порт SSH из секретов GitHub (опционально, по умолчанию 22)
          source: "./" # Копируем все файлы и папки из корня репозитория
          target: "/home/admin2/ars-backend" # Целевая директория на сервере
          # Опционально: исключите определенные директории/файлы при копировании
          # exclude: ".git,.github,node_modules,dist"

      - name: Configure and Restart Medusa service
        # Используем action для выполнения команды по SSH
        uses: appleboy/ssh-action@v1.0.0 # Проверьте наличие более новой версии, если хотите
        with:
          host: ${{ secrets.SSH_HOST }} # IP-адрес сервера из секретов GitHub
          username: ${{ secrets.SSH_USER }} # Имя пользователя SSH из секретов GitHub
          key: ${{ secrets.SERVER_SSH_KEY }} # Приватный SSH-ключ из секретов GitHub
          port: ${{ secrets.SSH_PORT }} # Порт SSH из секретов GitHub (опционально, по умолчанию 22)

          script: |
            echo "Executing deployment script on server..."

            # Переходим в директорию проекта на сервере
            cd /home/admin2/ars-backend || { echo "Error: Directory /home/admin2/ars-backend not found"; exit 1; }   

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22.13.1

            # --- Установка зависимостей ---
            echo "Running yarn install..."
            # Используем --frozen-lockfile в CI/CD для предсказуемости
            # --production пропустит devDependencies
            yarn install --immutable --immutable-cache || { echo "Error: yarn install failed"; exit 1; }
            echo "yarn install finished." 

            # --- Восстанавливаем .env ---
            - name: Restore .env
              run: |
                if [ -f /home/admin2/secrets/.env-backend ]; then
                  cp /home/admin2/secrets/.env-backend .env.production
                  echo ".env.production restored"
                else
                  echo "No .env-backend to copy"
                fi

            # --- Сборка проекта ---
            # Medusa часто требует сборки (например, компиляция TypeScript) перед запуском.
            echo "Running build..."
            yarn build || { echo "Error: build failed"; exit 1; }
            echo "build finished."

            # ---  установка зависимостей и миграции ---
            cd .medusa/server && yarn install && yarn predeploy


            # Перезапуск сервера
            if pm2 exists medusa-server > /dev/null 2>&1; then
              pm2 restart medusa-server || { echo "Error: Failed to restart 'medusa-server'"; exit 1; }
              echo "PM2 process 'medusa-server' restarted successfully."
            else
              npx pm2 start --name medusa-server --yarn start --env production || { echo "Error: Failed to start 'medusa-server'"; exit 1; }
              echo "PM2 process 'medusa-server' started successfully."
            fi

            # Перезапуск воркера
            if pm2 exists medusa-worker > /dev/null 2>&1; then
              pm2 restart medusa-worker || { echo "Error: Failed to restart 'medusa-worker'"; exit 1; }
              echo "PM2 process 'medusa-worker' restarted successfully."
            else
              npx pm2 start --name medusa-worker --yarn start --env production -- DISABLE_MEDUSA_ADMIN=true MEDUSA_WORKER_MODE=worker || { echo "Error: Failed to start 'medusa-worker'"; exit 1; }
              echo "PM2 process 'medusa-worker' started successfully."
            fi

            echo "Deployment script finished."
